# Sequence diagrams and examples - Integrating EHR with the SFM client


The EHR system  must implement support to request HelseID for access tokens with audiences to SFM and a function to renew tokens in order to support single-sign-on for local login, use of SFM and communication with underlying services.

The sequence diagram and accompanying descriptions documents the process of integrating external EPJ systems with the SFM.


## Sequence Diagram

![Sequence diagrams](https://github.com/NorskHelsenett/SFM.tools/blob/main/doc/SFM%20Full/seq_and_ex/sfm_full_sequence_portal.png)

## Authentication

Authentication is required against the Norwegian IDP for proper identification of the SFM.

![HelseID login](https://github.com/NorskHelsenett/SFM.tools/blob/main/doc/SFM%20Full/seq_and_ex/sfm_full_helseidlogin.png)

After authenticating using OpenId you should be redirected back to the EPJ and receive an access_token that represents the selected organization in the SFM.

## Creating an SFM session

After having received a valid ´access_token´ a call needs to be made to the SFM Service Gateway in order to create a new SFM session and the response will contain the portal addresses you can use.

Below is an example of an HTTP POST request that creates a session.

  POST {{SfmSessionGatewayEndpoint}}/api/Session/create
  Authorization: Bearer {{access_token}}
  ContentType: application/json
  
  {
    "nonce": "{{nonceHashBase64}}"
  }

| Variable      | Meaning |  
| :---        |    :----:   |     
| {{SfmSessionGatewayEndpoint}} |   Base address of Sfm Session Gateway endpoint  |       
| {{access_token}}        |   Access token returned from Authentication against the Norwegian IDP |     
| nonceHashBase64        |    The hash of a nonce base64 randomly generated by the EPJ system. To generate a nonce see the section below “Generating the nonce" |      
